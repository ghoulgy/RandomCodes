import idautils

'''
Example:

push edi
pushfd
mov edi, esp
or dword ptr ds:[edi], ebx
popfd
cmp cx, bx
js 0x02F71E86
'''

search_byte = 0x9d

for address in range(0x18F086A, 0x019A2092):
    if get_db_byte(address) == search_byte and print_insn_mnem(address) == "popf":
        address_next = idc.next_head(address)
        address_next = idc.next_head(address_next)
        
        address_prev = idc.prev_head(address)
        address_prev = idc.prev_head(address_prev)
        address_prev = idc.prev_head(address_prev)

        # print(print_insn_mnem(address_prev))
        if print_insn_mnem(address_next).startswith("j") and print_insn_mnem(address_prev) == "pushf":
            addr_ofs = get_db_byte(address_next + 2)
            print(hex(addr_ofs))
            nxt_jmp_addr = address_next + (addr_ofs ^ 0x74)
            print(f"Byte 0x9d found at address: 0x{address:08X}")
            # print(hex(address))
            print(f"Next jump addr: {hex(nxt_jmp_addr)}")
            
            range_to_nxt_byte = nxt_jmp_addr - address_next - 2      
            if range_to_nxt_byte > 0:
                patch_bytes = f"{nxt_jmp_addr-address_next-2:02x}"+"eb"
                print(f"Byte code to patch in 0x{address_next:08X}: {patch_bytes}")
                print(hex(int(patch_bytes, 16)))
                ida_bytes.patch_word(address_next, int(patch_bytes, 16))
