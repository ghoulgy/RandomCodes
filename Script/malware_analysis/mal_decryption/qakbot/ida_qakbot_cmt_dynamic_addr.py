func_addr_dict = {
    "4C80D18": { # advapi32
        "2004176368": "SetFileSecurityW",
        "2004155664": "AdjustTokenPrivileges",
        "2004174896": "SetEntriesInAclA",
        "2004152160": "AllocateAndInitializeSid",
        "2004155200": "FreeSid",
        "2004151264": "RegOpenKeyExA",
        "2004150816": "RegQueryValueExA",
        "2004151024": "RegCloseKey",
        "2004149888": "ConvertSidToStringSidA",
        "2004149392": "ConvertSidToStringSidW",
        "2004168224": "RegCreateKeyA",
        "2004156560": "RegSetValueExA",
        "2004244752": "RegLoadKeyW",
        "2004245168": "RegUnLoadKeyW",
        "2004157392": "OpenSCManagerW",
        "2004239872": "CreateServiceW",
        "2004176304": "StartServiceW",
        "2004241904": "DeleteService",
        "2004157232": "CloseServiceHandle",
        "2004155136": "CryptAcquireContextA",
        "2004152032": "CryptCreateHash",
        "2004152320": "CryptHashData",
        "2004241872": "CryptVerifySignatureA",
        "2004153488": "CryptReleaseContext",
        "2004153200": "CryptDestroyKey",
        "2004153104": "CryptDestroyHash",
        "2004157088": "EqualSid",
        "2004151392": "LookupAccountSidW",
        "2004150784": "OpenProcessToken",
        "2004149856": "GetTokenInformation",
        "2004150416": "OpenThreadToken",
        "2004152416": "GetSidSubAuthorityCount",
        "2004152064": "GetSidSubAuthority",
        "2004125344": "ConvertStringSecurityDescriptorToSecurityDescriptorW",
        "2004174064": "GetSecurityDescriptorSacl",
        "2004156528": "SetSecurityInfo",
        "2004153024": "InitializeSecurityDescriptor",
        "2004152352": "SetSecurityDescriptorDacl",
        "2004173888": "LookupPrivilegeValueA",
        "2004176464": "StartServiceCtrlDispatcherA",
        "2004157360": "SetServiceStatus",
        "2004245200": "RegisterServiceCtrlHandlerA",
        "2004156944": "RegDeleteValueW",
        "2004150656": "RegOpenKeyExW",
        "2004150992": "RegQueryInfoKeyW",
        "2004157600": "RegDeleteValueA",
        "2004150736": "IsTextUnicode",
        "2004150448": "RegQueryValueExW",
        "2004151232": "RegSetValueExW",
        "2004153232": "LookupAccountNameW",
        "2004151152": "RegEnumValueW",
        "2004240032": "CredEnumerateA",
        "2004240128": "CredFree"
    },
    "4C80D2C": { # gdi32
        "1979018704": "CreateCompatibleDC",
        "1979015168": "GetDeviceCaps",
        "1979019440": "CreateCompatibleBitmap",
        "1979018464": "SelectObject",
        "1979018784": "BitBlt",
        "1979018640": "GetObjectW",
        "1979019504": "GetDIBits",
        "1979017424": "DeleteDC",
        "1979013312": "DeleteObject"
    },
    "4C80CF8": { # kernel32
        "1984041632": "LoadLibraryA",
        "1984044432": "LoadLibraryW",
        "1984041392": "FreeLibrary",
        "1984035712": "GetProcAddress",
        "1984041264": "GetModuleHandleA",
        "1984042272": "GetModuleHandleW",
        "1984059808": "CreateToolhelp32Snapshot",
        "1984281328": "Module32First",
        "1984281744": "Module32Next",
        "1984128512": "WriteProcessMemory",
        "1984040192": "OpenProcess",
        "1984127952": "VirtualFreeEx",
        "1984051104": "WaitForSingleObject",
        "1984050608": "CloseHandle",
        "1984035680": "LocalFree",
        "1984006368": "CreateProcessW",
        "1984124976": "ReadProcessMemory",
        "1984008672": "Process32First",
        "1984002384": "Process32Next",
        "1984045776": "Process32FirstW",
        "1984040528": "Process32NextW",
        "1984119184": "CreateProcessAsUserW",
        "1984127920": "VirtualAllocEx",
        "1984035312": "VirtualAlloc",
        "1984035568": "VirtualFree",
        "1984035808": "OpenThread",
        "1984006176": "Wow64DisableWow64FsRedirection",
        "1984301360": "Wow64EnableWow64FsRedirection",
        "1984052000": "GetVolumeInformationW",
        "1984040368": "IsWow64Process",
        "1984042464": "CreateThread",
        "1984051216": "CreateFileW",
        "1984051200": "CreateFileA",
        "1984051312": "FindClose",
        "1984051728": "GetFileAttributesW",
        "1984052256": "SetFilePointer",
        "1984052352": "WriteFile",
        "1984052112": "ReadFile",
        "1984050752": "CreateMutexA",
        "1984050976": "ReleaseMutex",
        "1983983280": "FindResourceA",
        "1983979360": "FindResourceW",
        "1984039760": "SizeofResource",
        "1984032368": "LoadResource",
        "1984024560": "GetTickCount64",
        "1984042416": "ExpandEnvironmentStringsW",
        "1984122000": "GetThreadContext",
        "1984030160": "SetLastError",
        "1984043632": "GetComputerNameW",
        "1984042448": "Sleep",
        "1984051056": "SleepEx",
        "1984050896": "OpenEventA",
        "1984051024": "SetEvent",
        "1984050688": "CreateEventA",
        "1984127600": "TerminateThread",
        "1984124640": "QueryFullProcessImageNameW",
        "1984047504": "CreateNamedPipeA",
        "1984047712": "ConnectNamedPipe",
        "1984041520": "GetLocalTime",
        "1984059776": "ExitProcess",
        "1984040752": "GetEnvironmentVariableW",
        "1984047024": "GetExitCodeThread",
        "1984051760": "GetFileSize",
        "1984039824": "VirtualProtect",
        "1984127984": "VirtualProtectEx",
        "1983991088": "InterlockedCompareExchange",
        "1984119280": "CreateRemoteThread",
        "1984005664": "SetEnvironmentVariableW",
        "1984044992": "ResumeThread",
        "1984010512": "TerminateProcess",
        "2009837856": "RtlAddVectoredExceptionHandler",
        "1984051264": "DeleteFileW",
        "1984052912": "CopyFileW",
        "1984053040": "AllocConsole",
        "1984053296": "SetConsoleCtrlHandler",
        "1984040912": "GetModuleFileNameW",
        "1984050512": "GetCurrentProcess",
        "1984119088": "CreatePipe",
        "1984009408": "GetExitCodeProcess",
        "1984046144": "GetCommandLineW"
    },
    "4C80D20": { # netapi32
        "1905739200": "NetShareEnum",
        "1848261072": "NetUserEnum",
        "1822825280": "NetWkstaGetInfo",
        "1905596480": "NetApiBufferFree",
        "1822685792": "NetGetDCName",
        "1855403536": "NetGetJoinInformation"
    },
    "4C80D34": { # ntdll
        "2009947760": "RtlAllocateHeap",
        "2009939104": "RtlFreeHeap",
        "2009857936": "RtlGetVersion",
        "2010132368": "ZwCreateSection",
        "2010131856": "ZwUnmapViewOfSection",
        "2010131824": "ZwMapViewOfSection",
        "2010132112": "ZwWriteVirtualMemory",
        "2010132464": "ZwProtectVirtualMemory",
        "2010131392": "ZwClose",
        "2010131776": "ZwQueryInformationThread",
        "2010141072": "RtlInitUnicodeString",
        "2010406416": "RtlCreateProcessParametersEx"
    },
    "4C80D0C": { # shell32
        "1996904016": "ShellExecuteW",
        "1996938720": "SHGetFolderPathW"
    },
    "4C80D30": { # shlwapi
        "1985311632": "StrStrIA",
        "1985302912": "StrStrIW",
        "1985326256": "StrCmpIW",
        "1985323472": "PathCombineA",
        "1985311568": "PathCombineW",
        "1985324368": "PathMatchSpecA",
        "1985324464": "PathMatchSpecW",
        "1985306656": "PathUnquoteSpacesW",
        "1985305632": "StrTrimW",
        "1985326416": "StrCmpNIA",
        "1985327120": "StrStrW"
    },
    "4C80CF0": { # user32
        "1982536160": "MessageBoxA",
        "1982176576": "EnumWindows",
        "1982145664": "RegisterClassExA",
        "1982171472": "CreateWindowExA",
        "1982270608": "ChangeWindowMessageFilter",
        "1982278800": "ShowWindow",
        "1982221728": "UpdateWindow",
        "1982152560": "GetMessageA",
        "1982245504": "TranslateMessage",
        "1982169744": "DispatchMessageA",
        "1982274368": "DestroyWindow",
        "1982174720": "UnregisterClassA",
        "1982271168": "PostQuitMessage",
        "2010218512": "NtdllDefWindowProc_A",
        "1982275344": "GetKeyboardLayoutList",
        "1982222816": "GetSystemMetrics",
        "1982275728": "GetProcessWindowStation",
        "1982275968": "GetUserObjectInformationW",
        "1982579392": "CharUpperBuffW",
        "1982579360": "CharUpperBuffA",
        "1982153904": "GetClassNameA",
        "1982275184": "GetForegroundWindow",
        "1982263984": "GetDC",
        "1982275072": "GetCursorInfo",
        "1982167344": "CopyIcon",
        "1982267088": "GetIconInfo",
        "1982159536": "DrawIconEx"
    },
    "4C80D24": { # userenv
        "1844278064": "GetUserProfileDirectoryW"
    },
    "4C80D04": { # ws2_32 
        "1991597392": "WSAGetLastError",
        "1991598672": "WSASetLastError",
        "1991596352": "inet_ntoa",
        "1991596000": "inet_addr"
    }
}

base_addr = {
    "4C80D18": "77730000", # advapi
    # "logoncli.dll": "6CA20000",     
    "4C80D20": "6CA60000", # netapi     
    "4C80D24": "6DED0000", # userenv     
    # "samcli.dll": "6E2A0000",       
    # "wkscli.dll": "6E970000",       
    # "windowscodecs.dll": "70B30000",
    # "netutils.dll": "71950000",     
    # "srvcli.dll": "71970000",       
    # "uxtheme.dll": "72D90000",      
    # "ole32.dll": "75B50000",        
    # "combase.dll": "75C40000",      
    # "gdi32.dll": "75F50000",        
    # "rpcrt4.dll": "75F80000",       
    # "bcrypt.dll": "76040000",       
    "4C80CF0": "76230000", # user32      
    # "win32u.dll": "763D0000",       
    "4C80CF8": "76400000", # kernel32     
    "4C80D30": "76540000", # shlwapi      
    # "kernelbase.dll": "76640000",   
    # "gdi32full.dll": "76860000",    
    # "sechost.dll": "76960000",      
    "4C80D04": "76B50000", # ws2_32   
    # "oleaut32.dll": "76BC0000",     
    # "msvcrt.dll": "76D20000",       
    # "ucrtbase.dll": "76DF0000",     
    "4C80D0C": "76F10000", # shell32      
    # "imm32.dll": "77680000",        
    # "msvcp_win.dll": "776B0000",    
    "4C80D34": "77C90000" # ntdll
}

import re

# start_addr = 0x1000D95D
start_addr = 0x10001c80
# end_addr = 0x1000DA51
end_addr = 0x10015700
is_mem_addr_found = False
hex_str = ""
hex_with_func = ["4C80D18", "4C80D20", "4C80D24", "4C80CF0", "4C80CF8", "4C80D30", "4C80D04", "4C80D0C", "4C80D34"]

# print(func_addr_dict.keys())

while start_addr < end_addr:
    if idc.print_insn_mnem(start_addr) == "mov": 

        # print(hex(start_addr), idc.print_operand(start_addr, 1))
        if idc.print_operand(start_addr, 1)[:3] == "ds:" and idc.print_operand(start_addr, 1)[-1] == "h": 
            registry_type = idc.print_operand(start_addr, 0)
            hex_str = idc.print_operand(start_addr, 1).replace("ds:", "")[:-1]
            # print(hex_str, hex(start_addr))
            if hex_str in hex_with_func and hex_str in func_addr_dict.keys():
                is_mem_addr_found = True 

    if is_mem_addr_found and idc.print_insn_mnem(start_addr) == "call":
        dynamic_offset_operand = idc.print_operand(start_addr, 0)
        if "sub_" not in dynamic_offset_operand and registry_type in dynamic_offset_operand:
            # print(f"{hex(start_addr)} {dynamic_offset_operand}")
            re_offset_val = re.search(r"([0-9A-Fa-f]+)h\]", dynamic_offset_operand)
            try:
                offset_val = re_offset_val.group(1)
            except:
                offset_val = 0

            if offset_val == 0:
                print(f"{hex_str} : {hex(start_addr)} : {list(func_addr_dict[hex_str].values())[0]}")
                idc.set_cmt(start_addr, list(func_addr_dict[hex_str].values())[0], 0)

            else:
                try:
                    print(f"{hex_str} : {hex(start_addr)} : {(int((int(offset_val, 16)) / 4))} : {list(func_addr_dict[hex_str].values())[(int((int(offset_val, 16)) / 4))]}")
                    idc.set_cmt(start_addr, list(func_addr_dict[hex_str].values())[(int((int(offset_val, 16)) / 4))], 0)

                except:
                    print(f"ERR: {hex_str} : {hex(start_addr)} : {((int(int(offset_val, 16)) / 4))}")
            
            is_mem_addr_found = False

    start_addr = idc.next_head(start_addr)
